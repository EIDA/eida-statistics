openapi: 3.0.1
info:
  title: EIDA statistics service
  description: |
    This service provides unified usage statistics for services distributed in the <a href="https://www.orfeus-eu.org/data/eida/">EIDA</a> federation.<br>
    This documentation lists all the methods and details the usage possibilities available over HTTP protocol.
  version: 1.0.0
externalDocs:
  description: Webservice github page
  url: https://github.com/EIDA/eida-statistics/tree/main/webservice
paths:
  /dataselect/raw:
    post:
      tags:
        - Statistics
      description: |
        Get statistics meant to be convenient for programs. Authentication required. Different behavior depending on whether the user is data center operator or not. Statistics for restricted networks are available only if user is properly authorized for each specific network.
      parameters:
        - in: query
          name: start
          description: |
            Start month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: end
          description: |
            End month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation. Comma separated list is possible only if the user is data center operator. For non-operators, a single data center must be specified.
          schema:
            type: string
            example: RESIF,NOA
        - in: query
          name: network
          description: |
            FDSN extended network code (for temporary networks: XX2022; for permanent networks: GE). Comma separated list is possible only if the user is data center operator. For non-operators, a single network must be specified.
          schema:
            type: string
            example: Z32015,FR
        - in: query
          name: station
          description: |
            FDSN extended station code. Comma separated list is possible.
          schema:
            type: string
            example: 'A*'
        - in: query
          name: location
          description: |
            FDSN extended location code. Comma separated list is possible.
          schema:
            type: string
            example: '00'
        - in: query
          name: channel
          description: |
            FDSN extended channel code. Comma separated list is possible.
          schema:
            type: string
            example: HHZ
        - in: query
          name: country
          description: |
            Country code. Comma separated list is possible.
          schema:
            type: string
            example: FR,GR
      requestBody:
        description: A file that contains the EIDA authentication system token
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Successful request, results follow
          content:
            application/json:
              schema:
                type: object
                $ref: '#/components/schemas/StatisticsComputerResponseObject'
        '400':
          description: Bad request due to unrecognised parameter, unsupported parameter value etc.
        '401':
          description: Unauthorized. No valid token provided
        '403':
          description: Forbidden. User has no access to the requested data
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
  /dataselect/public:
    get:
      tags:
        - Statistics
      description: |
        Get public statistics meant to be convenient for humans. No authentication required. Statistics for restricted networks are not available.
      parameters:
        - in: query
          name: start
          description: |
            Start month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: end
          description: |
            End month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation. Comma separated list is possible in data center level (i.e. when network parameter is not specified).
          schema:
            type: string
            example: RESIF,NOA
        - in: query
          name: network
          description: |
            FDSN extended network code (for temporary networks: XX2022; for permanent networks: GE).
          schema:
            type: string
            example: HL
        - in: query
          name: country
          description: |
            Country code. Comma separated list is possible.
          schema:
            type: string
            example: FR,GR
        - in: query
          name: aggregate_on
          description: |
            Aggregate on one or more parameters to see total results for all available values of the parameter. E.g. <i>aggregate_on=month</i> to see results in total across all months given in the corresponding parameter. If no specific month was given, then request returns total statistics for all months that exist in the database.<br><i>aggregate_on=all</i> is a shortcut for <i>aggregate_on=month,datacenter,network,station,country,location,channel</i>.<br>Aggregation for station, location and channel is forced. Network aggregation is also forced when no network is specified. Aggregation is meaningful for month, datacenter and country parameters.
          schema:
            type: string
            default: station,location,channel
        - in: query
          name: format
          description: |
            Output format. Specify 'csv' or 'json'
          schema:
            type: string
            enum:
              - json
              - csv
            default: csv
      responses:
        '200':
          description: Successful request, results follow
          content:
            text/csv:
              schema:
                type: string
                example: "# version: 1.0.0\n# matching: start=2021-01&end=2021-12&datacenter=RESIF&country=GR,FR\n# aggregated_on: month,country,network,station,location,channel\nmonth,datacenter,network,station,location,channel,country,bytes,nb_reqs,nb_successful_reqs,clients\n*,RESIF,*,*,*,*,*,56,40,561234,34\n..."
            application/json:
              schema:
                type: object
                $ref: '#/components/schemas/StatisticsPublicResponseObject'
        '400':
          description: Bad request due to unrecognised parameter, unsupported parameter value etc.
        '500':
          description: Internal server error
  /dataselect/restricted:
    post:
      tags:
        - Statistics
      description: |
        Get statistics meant to be convenient for humans. Authentication required. Different behavior depending on whether the user is data center operator or not. Statistics for restricted networks are available only if user is properly authorized for each specific network.
      parameters:
        - in: query
          name: start
          description: |
            Start month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: end
          description: |
            End month for time window; ISO-8601 YYYY-MM
          schema:
            type: string
            example: 2023-01
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation. Comma separated list is possible in data center level or if the user is data center operator. For non-operators, a single data center must be specified whenever any of the network, station, location, channel parameters is specified.
          schema:
            type: string
            example: RESIF,NOA
        - in: query
          name: network
          description: |
            FDSN extended network code (for temporary networks: XX2022; for permanent networks: GE). Comma separated list is possible only if the user is data center operator. For non-operators, a single network must be specified whenever any of the network, station, location, channel parameters is specified.
          schema:
            type: string
            example: Z32015,FR
        - in: query
          name: station
          description: |
            FDSN extended station code. Comma separated list is possible.
          schema:
            type: string
            example: 'A*'
        - in: query
          name: location
          description: |
            FDSN extended location code. Comma separated list is possible.
          schema:
            type: string
            example: '00'
        - in: query
          name: channel
          description: |
            FDSN extended channel code. Comma separated list is possible.
          schema:
            type: string
            example: HHZ
        - in: query
          name: country
          description: |
            Country code. Comma separated list is possible.
          schema:
            type: string
            example: FR,GR
        - in: query
          name: aggregate_on
          description: |
            Aggregate on one or more parameters to see total results for all available values of the parameter. E.g. <i>aggregate_on=month</i> to see results in total across all months given in the corresponding parameter. If no specific month was given, then request returns total statistics for all months that exist in the database.<br><i>aggregate_on=all</i> is a shortcut for <i>aggregate_on=month,datacenter,network,station,country,location,channel</i>.<br>Aggregation for location and channel is forced.<br>For data center operators, aggregation is meaningful for month, datacenter, network, station, country parameters.<br>For non-operators, aggregation is meaningful for month, datacenter, station, country. For non-operators, aggregation is also forced for network and station if none of network, station, location or channel parameters is specified (i.e. statistics in data center level); for this case, aggregation is meaningful for month, datacenter and country parameters.
          schema:
            type: string
            default: location,channel
        - in: query
          name: format
          description: |
            Output format. Specify 'csv' or 'json'
          schema:
            type: string
            enum:
              - json
              - csv
            default: csv
      requestBody:
        description: A file that contains the EIDA authentication system token
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Successful request, results follow
          content:
            text/csv:
              schema:
                type: string
                example: "# version: 1.0.0\n# matching: start=2021-01&end=2021-12&datacenter=RESIF&network=NL&station=STA*&country=GR,FR\n# aggregated_on: month,country,location,channel\nmonth,datacenter,network,station,location,channel,country,bytes,nb_reqs,nb_successful_reqs,clients\n*,RESIF,NL,HGN,*,*,*,56,40,561234,34\n..."
            application/json:
              schema:
                type: object
                $ref: '#/components/schemas/StatisticsHumanResponseObject'
        '400':
          description: Bad request due to unrecognised parameter, unsupported parameter value etc.
        '401':
          description: Unauthorized. No valid token provided
        '403':
          description: Forbidden. User has no access to the requested data
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
  /submit:
    put:
      tags:
        - Statistics
      summary: |
        Append a statistic aggregation. If any value exists on the server side, submitted values will be appended.
      operationId: updateStat
      requestBody:
        description: An aggregation file as created by the aggregator, JSON gzipped.
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Stat'
        required: true
      responses:
        '200':
          description: Statistic successfully ingested to database
        '400':
          description: Bad request due to malformed JSON payload object
        '401':
          description: No token provided
        '403':
          description: No valid token provided
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
      security:
      - bearerAuth:
        - write:eidanode
      x-codegen-request-body-name: body
    post:
      tags:
      - Statistics
      summary: Submit a new statistic aggregation
      operationId: addStat
      requestBody:
        description: Submit a statistic generated by the aggregator. If any value exists, it will be overwritten.
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/Stat'
        required: true
      responses:
        '200':
          description: Statistic successfully ingested to database
        '400':
          description: Bad request due to malformed JSON payload object
        '401':
          description: No token provided
        '403':
          description: No valid token provided
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
      security:
      - bearerAuth:
        - write:eidanode
      x-codegen-request-body-name: body
  /node_restriction_policy:
    post:
      tags:
        - Network restrictions
      description: |
        Allows data center operators to view or modify the default restriction policy of their data center. Authentication required. If default restriction policy is about to be changed and some networks become restricted, then an EAS network group name should be specified for each one of them, if there is not one already (see /network_restriction_policy method).
      parameters:
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation.
          required: true
          schema:
            type: string
            example: NOA
        - in: query
          name: policy
          description: |
            Default restriction policy of data center. 0 for open networks, 1 for restricted networks. If not specified, then the current policy is returned.
          schema:
            type: integer
            example: 0
      requestBody:
        description: A file that contains the EIDA authentication system token
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Successful request, results follow
          content:
            application/json:
              schema:
                type: object
                properties:
                  restriction_policy:
                    type: string
                    example: 0
        '400':
          description: Bad request due to unrecognised parameter, unsupported parameter value etc.
        '401':
          description: Unauthorized. No valid token provided
        '403':
          description: Forbidden. User has no authority to perform the requested action
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
  /network_restriction_policy:
    post:
      tags:
        - Network restrictions
      description: |
        Allows data center operators to view or modify the restriction policy of a specific network of their data center. Authentication required.
      parameters:
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation.
          required: true
          schema:
            type: string
            example: NOA
        - in: query
          name: network
          description: |
            FDSN extended network code (for temporary networks: XX2022; for permanent networks: GE).
          required: true
          schema:
            type: string
            example: HL
        - in: query
          name: invert_policy
          description: |
            Whether network restriction policy agrees with its data center default or not. 0 means network has same policy as its data center, 1 means network has the opposite policy. If not specified, then the current state of network is returned.
          schema:
            type: integer
            example: 0
        - in: query
          name: eas_group
          description: |
            EAS network group name. If no such name exists in database and network is about to be restricted, non-operator users will not be able to get statistics for this network under any circumstances until such a group name is specified. If left empty, the current group name is not changed.
          schema:
            type: string
      requestBody:
        description: A file that contains the EIDA authentication system token
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Successful request, results follow
          content:
            application/json:
              schema:
                type: object
                properties:
                  invert_policy:
                    type: string
                    example: 0
                  eas_group:
                    type: string
                    example: Y0HBP
        '400':
          description: Bad request due to unrecognised parameter, unsupported parameter value etc.
        '401':
          description: Unauthorized. No valid token provided
        '403':
          description: Forbidden. User has no authority to perform the requested action
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
  /_health:
    get:
      tags:
        - Internal
      description: |
        Returns OK message if service available and correctly connected to the database backend.
      responses:
        '200':
          description: Service running and database available
        '500':
          description: Internal server error
  /_nodes:
    get:
      tags:
        - Internal
      description: |
        Get list of nodes. Meant for internal use.
      responses:
        '200':
          description: Successful request, results follow
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      type: string
                    example: [RESIF,NOA,GEOFON]
        '500':
          description: Internal server error
  /_isRestricted:
    get:
      tags:
        - Internal
      description: |
        Returns if a given network is restricted or not. It also returns EAS group of network. Meant for internal use.
      parameters:
        - in: query
          name: datacenter
          description: |
            Data center member of EIDA federation.
          required: true
          schema:
            type: string
            example: NOA
        - in: query
          name: network
          description: |
            FDSN extended network code (for temporary networks: XX2022; for permanent networks: GE).
          required: true
          schema:
            type: string
            example: HL
      responses:
        '200':
          description: Successful request, results follow
          content:
            application/json:
              schema:
                type: object
                properties:
                  restricted:
                    type: string
                    example: yes
                  group:
                    type: string
                    example: Y0HBP
                    nullable: true
        '400':
          description: Bad request due to unrecognised parameter, not giving required parameters or no such network in database.
        '500':
          description: Internal server error
components:
  schemas:
    StatisticsComputerResponseObject:
      type: object
      properties:
        version:
          type: string
          example: 1.0.0
        request_parameters:
          type: string
          example: 'start=2021-01&end=2021-12&datacenter=RESIF&network=NL&sta=STA*&country=GR,FR'
        results:
          type: array
          items:
            $ref: '#/components/schemas/ComputerResponseResult'
    ComputerResponseResult:
      type: object
      properties:
        month:
          type: string
          example: 2022-11
        datacenter:
          type: string
          example: RESIF
        network:
          type: string
          example: NL
        station:
          type: string
          example: HGN
        location:
          type: string
          example: 00
        channel:
          type: string
          example: HHZ
        country:
          type: string
          example: GR
          nullable: true
        bytes:
          type: integer
          example: 561234
        nb_reqs:
          type: integer
          example: 56
        nb_successful_reqs:
          type: integer
          example: 40
        clients:
          type: string
          example: \x128b7fffffffff8ef137c60000000002832c9b
          description: HyperLogLog hash object
    StatisticsHumanResponseObject:
      type: object
      properties:
        version:
          type: string
          example: 1.0.0
        matching:
          type: string
          example: 'start=2021-01&end=2021-12&datacenter=RESIF&network=NL&station=STA*&country=GR,FR'
        aggregated_on:
          type: string
          example: 'month,country,location,channel'
        results:
          type: array
          items:
            $ref: '#/components/schemas/HumanResponseResult'
    HumanResponseResult:
      type: object
      properties:
        month:
          type: string
          example: '*'
        datacenter:
          type: string
          example: RESIF
        network:
          type: string
          example: NL
        station:
          type: string
          example: HGN
        location:
          type: string
          example: '*'
        channel:
          type: string
          example: '*'
        country:
          type: string
          example: '*'
          nullable: true
        bytes:
          type: integer
          example: 561234
        nb_reqs:
          type: integer
          example: 56
        nb_successful_reqs:
          type: integer
          example: 40
        clients:
          type: integer
          example: 34
          description: This is an evaluation of the internal representation in the database
    StatisticsPublicResponseObject:
      type: object
      properties:
        version:
          type: string
          example: 1.0.0
        matching:
          type: string
          example: 'start=2021-01&end=2021-12&datacenter=RESIF&country=GR,FR'
        aggregated_on:
          type: string
          example: 'month,country,network,station,location,channel'
        results:
          type: array
          items:
            $ref: '#/components/schemas/PublicResponseResult'
    PublicResponseResult:
      type: object
      properties:
        month:
          type: string
          example: '*'
        datacenter:
          type: string
          example: RESIF
        network:
          type: string
          example: '*'
        station:
          type: string
          example: '*'
        location:
          type: string
          example: '*'
        channel:
          type: string
          example: '*'
        country:
          type: string
          example: '*'
          nullable: true
        bytes:
          type: integer
          example: 561234
        nb_reqs:
          type: integer
          example: 56
        nb_successful_reqs:
          type: integer
          example: 40
        clients:
          type: integer
          example: 34
          description: This is an evaluation of the internal representation in the database
    Stat:
      required:
      - date
      - network
      - station
      - location
      - channel
      - country
      - bytes
      - nb_requests
      - nb_successful_requests
      - nb_unsuccessful_requests
      - clients
      type: object
      properties:
        date:
          type: string
          format: date
        network:
          type: string
        station:
          type: string
        location:
          type: string
        channel:
          type: string
        country:
          type: string
          nullable: true
        bytes:
          type: integer
          format: int64
        nb_requests:
          type: integer
          format: int64
        nb_successful_requests:
          type: integer
          format: int64
        nb_unsuccessful_requests:
          type: integer
          format: int64
        clients:
          type: string
          description: a HyperLogLog serialized object
  securitySchemes:
    bearerAuth:
      description: Token to be validated internally and allow statistics ingestion and restricted network modification
      type: http
      scheme: bearer
